# WebView

🌏 [English](README.en.md)

## 🚩 목차

* [개요](#개요)
* [스펙](#스펙)
* [플랫폼별 설정](#-플랫폼별-설정)
* [API](#-api)
* [Release notes](./ReleaseNotes.md)


## 개요

게임에서 다양하게 사용할 수 있는 웹뷰를 제공합니다.

## 스펙

### Unity 지원 버전

* 2018.4.0 이상

### Android 지원 버전

* 4.4 이상

### iOS 지원버전

* 11 이상

### 지원 플랫폼

* Android
* iOS 

### 지원하는 기능

| Category | Spec |
| --- | --- |
| Style | Popup |
|   | Fullscreen |
| Navigation | Visibility |
|   | Color |
|   | Title |
|   | Back |
|   | Forward |
|   | Close |
| Show API | URL, HTML file, HTML string |
|   | Callback |
|   | Scheme List |
| Position, Size API | SetPosition, GetX, GetY |
|   | SetSize, GetWidth, GetHeight |
|   | SetMargins |
| Show SafeBrowsing | |
|   | Callback |
| Other | IsActive |
|   | Execute JavaScript |
|   | Clear Cookies |
|   | Clear Cache |
|   | Can Go Back |
|   | Can Go Forward |
|   | Go Back |
|   | Go Forward |
|   | Multiple Windows |
|   | File upload</br>(Android API 21 이상) |
|   | User agent string |
|   | Set auto rotation |

## 🔨 플랫폼별 설정

###  Android

[Gradle](https://docs.unity3d.com/Manual/android-gradle-overview.html)을 사용하여 Android에서 필요한 종속성을 설정합니다.
Unity 2019.3 이전 버전의 프로젝트에서는 **Internal** 빌드 설정이 아닌 **Gradle**로 전환해야 합니다.

#### hardwareAccelerated 설정

원활한 WebView 사용을 위해 PostProcessBuild 스크립트에서 **hardwareAccelerated**를 활성화하고 있습니다.

#### Gradle 설정

1.  **File > Build Settings > Player Settings > Android > Publishing Settings**에서 **Custom Gradle Template**을 활성화하면 `Assets/Plugins/Android/mainTemplate.gradle` 파일이 생성됩니다.
    * ![unity_gradle.png](images/unity_gradle.png)
    * 사용 중인 mainTemplate.gradle 파일이 있을 때는 생략할 수 있습니다.
2.  mainTemplate.gradle의 주석 라인을 제거합니다.
    ```gradle
    // GENERATED BY UNITY. REMOVE THIS COMMENT TO PREVENT OVERWRITING WHEN EXPORTING AGAIN
    ```
3.  mainTemplate.gradle에서 dependencies를 추가합니다.
    ```gradle
    dependencies {
        implementation 'org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.3.72'
        
        // ShowSafeBrowsing API를 사용할 경우 추가
        implementation "androidx.browser:browser:1.3.0"
    }
    ```
    * 다른 패키지에서 이미 추가한 경우 해당 과정을 제외할 수 있습니다.

### iOS

#### Other Linker Flags 설정

Xcode Target(Unity-iPhone)에서 **Build Settings > Linking > Other Linker Flags**에 -ObjC를 추가해야 합니다.

#### GPMWebView.bundle

Unity 특정 버전에서 iOS 빌드 시, **내비게이션 바**의 버튼이 보이지 않는 현상이 발생할 수 있습니다.
해당 현상이 발생하면, Xcode Target(Unity-iPhone)의 **Xcode Project > Build Phases > Copy Bundle Resource** 설정에서 + 버튼을 눌러 `GPMWebView.bundle` 파일 검색하여 추가하십시오.

![GPMWebViewBundle.png](images/GPMWebViewBundle.png)

## 🔨 API

### ShowUrl

WebView를 표시합니다.

**Required 파라미터**

* url : 파라미터로 전송되는 url은 유효한 값이어야 합니다.
* configuration : GpmWebViewRequest.Configuration으로 WebView의 옵션을 변경할 수 있습니다.

**Optional 파라미터**

* callback : WebView에서 발생하는 콜백을 전달받습니다.
* schemeList : 사용자가 받고 싶은 커스텀 스킴(scheme) 목록을 지정합니다.
    * 'https://'를 입력하면 'https://'로 시작하는 모든 url을 schemeEvent로 받을 수 있습니다.
    * schemeEvent로 받은 scheme은 redirect 되지 않습니다.

#### Configuration

| Parameter | Values | Description |
| ------------------------- | ----------------------------------------- | -------------------------------- |
| style                     | GpmWebViewStyle.POPUP                     | 팝업 모드 |
|                           | GpmWebViewStyle.FULLSCREEN                | 전체 화면 모드 |
| isClearCookie             | bool                                      | 쿠키 제거 |
| isClearCache              | bool                                      | 캐시 제거 |
| isNavigationBarVisible    | bool                                      | 네비게이션 바 활성 또는 비활성 |
|                           |                                           | Popup WebView Close 버튼 활성 또는 비활성 (iOS only) |
| navigationBarColor        | string                                    | 네비게이션 바 색상 |
| title                     | string                                    | WebView의 제목 |
| orientation               | UnityEngine.ScreenOrientation             | GPM WebView v1.1.0에서 제거되었습니다. |
| isBackButtonVisible       | bool                                      | 뒤로 가기 버튼 활성 또는 비활성  |
| isForwardButtonVisible    | bool                                      | 앞으로 가기 버튼 활성 또는 비활성 |
| supportMultipleWindows    | bool                                      | GPM WebView의 다중 창 지원 여부 |
| userAgentString           | string                                    | GPM WebView의 userAgentString 설정 |
| position                  | GpmWebViewRequest.Position                | Popup WebView 위치 지정 |
| size                      | GpmWebViewRequest.Size                    | Popup WebView 크기 지정 |
| margins                   | GpmWebViewRequest.Margins                 | Popup WebView 여백 지정 |
| isMaskViewVisible</br>(iOS only) | bool                               | Popup WebView 배경 활성 또는 비활성 |
| contentMode</br>(iOS only)| GamebaseWebViewContentMode.RECOMMENDED    | 현재 플랫폼 추천 브라우저 |
|                           | GamebaseWebViewContentMode.MOBILE         | 모바일 브라우저 |
|                           | GamebaseWebViewContentMode.DESKTOP        | 데스크탑 브라우저 |
| isAutoRotation</br>(iOS only) | bool                                  | WebView 회전 설정</br>Screen.orientation을 수동 설정하지 않을 때만 true를 지정합니다. |

**API**

```cs
public static void ShowUrl(
    string url,
    GpmWebViewRequest.Configuration configuration,
    GpmWebViewCallback.GpmWebViewDelegate callback,
    List<string> schemeList)
```

**Example**

```cs
// FullScreen
public void ShowUrlFullScreen()
{
    GpmWebView.ShowUrl(
        "https://google.com/",
        new GpmWebViewRequest.Configuration()
        {
            style = GpmWebViewStyle.FULLSCREEN,
            isClearCookie = true,
            isClearCache = true,
            isNavigationBarVisible = true,
            navigationBarColor = "#4B96E6",
            title = "The page title.",
            isBackButtonVisible = true,
            isForwardButtonVisible = true,
            supportMultipleWindows = true,
#if UNITY_IOS
            contentMode = GpmWebViewContentMode.MOBILE
#endif
        },
        OnCallback,
        new List<string>()
        {
            "USER_ CUSTOM_SCHEME"
        });
}

// Popup default
public void ShowUrlPopupDefault()
{
    GpmWebView.ShowUrl(
        "https://google.com/",
        new GpmWebViewRequest.Configuration()
        {
            style = GpmWebViewStyle.POPUP,
            isClearCookie = true,
            isClearCache = true,
            isNavigationBarVisible = false,
            supportMultipleWindows = true,
#if UNITY_IOS
            contentMode = GpmWebViewContentMode.MOBILE
            isMaskViewVisible = true,
#endif
        },
        OnCallback,
        new List<string>()
        {
            "USER_ CUSTOM_SCHEME"
        });
}

// Popup custom position and size
public void ShowUrlPopupPositionSize()
{
    GpmWebView.ShowUrl(
        "https://google.com/",
        new GpmWebViewRequest.Configuration()
        {
            style = GpmWebViewStyle.POPUP,
            isClearCookie = true,
            isClearCache = true,
            isNavigationBarVisible = false,
            position = new GpmWebViewRequest.Position
            {
                hasValue = true,
                x = (int)(Screen.width * 0.1f),
                y = (int)(Screen.height * 0.1f)
            },
            size = new GpmWebViewRequest.Size
            {
                hasValue = true,
                width = (int)(Screen.width * 0.8f),
                height = (int)(Screen.height * 0.8f)
            },
            supportMultipleWindows = true,
#if UNITY_IOS
            contentMode = GpmWebViewContentMode.MOBILE
            isMaskViewVisible = true,
#endif
        }, null, null);
}

// Popup custom margins
public void ShowUrlPopupMargins()
{
    GpmWebView.ShowUrl(
        "https://google.com/",
        new GpmWebViewRequest.Configuration()
        {
            style = GpmWebViewStyle.POPUP,
            isClearCookie = true,
            isClearCache = true,
            isNavigationBarVisible = false,
            margins = new GpmWebViewRequest.Margins
            {
                hasValue = true,
                left = (int)(Screen.width * 0.1f),
                top = (int)(Screen.height * 0.1f),
                right = (int)(Screen.width * 0.1f),
                bottom = (int)(Screen.height * 0.1f)
            },
            supportMultipleWindows = true,
#if UNITY_IOS
            contentMode = GpmWebViewContentMode.MOBILE
            isMaskViewVisible = true,
#endif
        }, null, null);
}

private void OnCallback(
    GpmWebViewCallback.CallbackType callbackType,
    string data,
    GpmWebViewError error)
{
    Debug.Log("OnCallback: " + callbackType);
    switch (callbackType)
    {
        case GpmWebViewCallback.CallbackType.Open:
            if (error != null)
            {
                Debug.LogFormat("Fail to open WebView. Error:{0}", error);
            }
            break;
        case GpmWebViewCallback.CallbackType.Close:
            if (error != null)
            {
                Debug.LogFormat("Fail to close WebView. Error:{0}", error);
            }
            break;
        case GpmWebViewCallback.CallbackType.PageLoad:
            if (string.IsNullOrEmpty(data) == false)
            {
                Debug.LogFormat("Loaded Page:{0}", data);
            }
            break;
        case GpmWebViewCallback.CallbackType.MultiWindowOpen:
            break;
        case GpmWebViewCallback.CallbackType.MultiWindowClose:
            break;
        case GpmWebViewCallback.CallbackType.Scheme:
            if (error == null)
            {
                if (data.Equals("USER_ CUSTOM_SCHEME") == true || data.Contains("CUSTOM_SCHEME") == true)
                {
                    Debug.Log(string.Format("scheme:{0}", data));
                }
            }
            else
            {
                Debug.Log(string.Format("Fail to custom scheme. Error:{0}", error));
            }
            break;
    }
}
```

### ShowHtmlFile

**Assets > StreamingAssets** 폴더에 있는 HTML 파일을 웹뷰에 불러옵니다.

![StreamingAssets.png](images/StreamingAssets.png)

ShowHtmlFile API의 filePath 값은 아래 코드를 참고하여 입력하십시오.

```cs
#if UNITY_IOS
    // "file://" + Application.streamingAssetsPath + "/" + "YOUR_HTML_PATH.html"
    string.Format("file://{0}/{1}", Application.streamingAssetsPath, "YOUR_HTML_PATH.html");
#elif UNITY_ANDROID
    // "file:///android_asset/" + "YOUR_HTML_PATH.html"
    string.Format("file:///android_asset/{0}", "YOUR_HTML_PATH.html");
#endif
```

**API**

```cs
public static void ShowHtmlFile(
    string filePath,
    GpmWebViewRequest.Configuration configuration,
    GpmWebViewCallback.GpmWebViewDelegate callback,
    List<string> schemeList)
```

**Example**

```cs
public void ShowHtmlFile()
{
    var htmlFilePath = string.Empty;
#if UNITY_IOS
        htmlFilePath = string.Format("file://{0}/{1}", Application.streamingAssetsPath, "YOUR_HTML_PATH.html");
#elif UNITY_ANDROID
        htmlFilePath = string.Format("file:///android_asset/{0}", "YOUR_HTML_PATH.html");
#endif

    GpmWebView.ShowHtmlFile(
        htmlFilePath,
        new GpmWebViewRequest.Configuration()
        {
            style = GpmWebViewStyle.FULLSCREEN,
            isClearCookie = true,
            isClearCache = true,
            isNavigationBarVisible = true,
            navigationBarColor = "#4B96E6",
            title = "The page title.",
            isBackButtonVisible = true,
            isForwardButtonVisible = true,
            supportMultipleWindows = true,
#if UNITY_IOS
            contentMode = GpmWebViewContentMode.MOBILE
#endif
        },
        OnCallback,
        new List<string>()
        {
            "USER_ CUSTOM_SCHEME"
        });
}

```

### ShowHtmlString

지정된 HTML 문자열을 웹뷰에 불러옵니다.

**API**

```cs
public static void ShowHtmlString(
    string htmlString,
    GpmWebViewRequest.Configuration configuration,
    GpmWebViewCallback.GpmWebViewDelegate callback,
    List<string> schemeList)
```

**Example**

```cs
public void ShowHtmlString()
{
    GpmWebView.ShowHtmlString(
        "${HTML_STRING}",
        new GpmWebViewRequest.Configuration()
        {
            style = GpmWebViewStyle.FULLSCREEN,
            isClearCookie = true,
            isClearCache = true,
            isNavigationBarVisible = true,
            navigationBarColor = "#4B96E6",
            title = "The page title.",
            isBackButtonVisible = true,
            isForwardButtonVisible = true,
            supportMultipleWindows = true,
#if UNITY_IOS
            contentMode = GpmWebViewContentMode.MOBILE
#endif
        },
        OnCallback,
        new List<string>()
        {
            "USER_ CUSTOM_SCHEME"
        });
}
```

### ShowSafeBrowsing

App에서 Android Chrome 또는 iOS Safari 브라우저를 표시합니다.</br>
👉 **GpmWebViewSafeBrowsing** class를 사용합니다.

**Required 파라미터**

* url : 파라미터로 전송되는 url은 유효한 값이어야 합니다.

**Optional 파라미터**

* configuration : GpmWebViewRequest.ConfigurationSafeBrowsing으로 NavigationBar의 색상을 변경할 수 있습니다.
* callback : 브라우저의 Open, Close 콜백을 전달받습니다.

#### Configuration

| Parameter | Values | Description |
| ------------------------- | ----------------------------------------- | -------------------------------- |
| navigationBarColor        | string                                    | 네비게이션 바 색상 |
| navigationTextColor</br>(iOS only) | string                           | 네비게이션 텍스트 색상 |

**API**

```cs
public static void ShowSafeBrowsing(
    string url,
    GpmWebViewRequest.ConfigurationSafeBrowsing configuration = null,
    GpmWebViewCallback.GpmWebViewDelegate callback = null)
```

**Example**

```cs
public void OpenSafeBrowsing()
{
    GpmWebViewSafeBrowsing.ShowSafeBrowsing(sampleUrl,
        new GpmWebViewRequest.ConfigurationSafeBrowsing()
        {
            navigationBarColor = "#4B96E6",
            navigationTextColor = "#FFFFFF"
        },
        OnCallback);
}
```

### ExecuteJavaScript

지정된 JavaScript 문자열을 실행합니다.

**API**

```cs
public static void ExecuteJavaScript(string script)
```

**Example**

```cs
public void ExecuteJavaScriptSample()
{
    GpmWebView.ExecuteJavaScript("alert('ExecuteJavaScript');");
}
```

### Close

다음 API를 이용해 WebView를 닫을 수 있습니다.

**API**

```cs
public static void Close()
```

**Example**

```cs
public void Close()
{
    GpmWebView.Close();
}
```

### IsActive

WebView 활성화 여부를 확인합니다.

**API**

```cs
public static bool IsActive()
```

**Example**

```cs
public bool Something()
{
    if (GpmWebView.IsActive() == true)
    {
        ...
    }
}
```

### CanGoBack

WebView에 이전 방문 기록이 있는지 확인합니다.

**API**

```cs
public static bool CanGoBack()
```

### CangoForward

WebView에 다음 방문 기록이 있는지 확인합니다.

```cs
public static bool CanGoForward()
```

### GoBack

WebView의 이전 방문 기록으로 이동합니다.

**API**

```cs
public static void GoBack()
```

**Example**

```cs
public void GoBack()
{
    GpmWebView.GoBack();
}
```

### GoForward

WebView의 다음 방문 기록으로 이동합니다.

**API**

```cs
public static void GoForward()
```

**Example**

```cs
public void GoForward()
{
    GpmWebView.GoForward();
}
```

### SetPosition

Popup WebView의 위치를 조정합니다.

**API**

```cs
public static void SetPosition(int x, int y)
```

**Example**

```cs
public IEnumerator SetPosition()
{
    while (true)
    {
        if (GpmWebView.IsActive() == true)
        {
            break;
        }
        yield return new WaitForEndOfFrame();
    }

    GpmWebView.SetPosition((int)(Screen.width * 0.1f), (int)(Screen.height * 0.1f));
}
```

### SetSize

Popup WebView의 크기를 조정합니다.

**API**

```cs
public static void SetSize(int width, int height)
```

**Example**

```cs
public IEnumerator SetSize()
{
    while (true)
    {
        if (GpmWebView.IsActive() == true)
        {
            break;
        }
        yield return new WaitForEndOfFrame();
    }

    GpmWebView.SetSize((int)(Screen.width * 0.8f), (int)(Screen.height * 0.8f));
}
```

### SetMargins

Popup WebView의 여백을 조정합니다.

**API**

```cs
public static void SetMargins(int left, int top, int right, int bottom)
```

**Example**

```cs
public IEnumerator SetMargins()
{
    while (true)
    {
        if (GpmWebView.IsActive() == true)
        {
            break;
        }
        yield return new WaitForEndOfFrame();
    }

    GpmWebView.SetMargins((int)(Screen.width * 0.1f), (int)(Screen.height * 0.1f), (int)(Screen.width * 0.1f), (int)(Screen.height * 0.1f));
}
```

### GetX, GetY

WebView의 위치를 반환합니다.

**API**

```cs
public static int GetX()
public static int GetY()
```

**Example**

```cs
public void Something()
{
    if (GpmWebView.IsActive() == true)
    {
        int x = GpmWebView.GetX();
        int y = GpmWebView.GetY();
        ...
    }
}
```

### GetWidth, GetHeight

WebView의 크기를 반환합니다.

**API**

```cs
public static int GetWidth()
public static int GetHeight()
```

**Example**

```cs
public void Something()
{
    if (GpmWebView.IsActive() == true)
    {
        int width = GpmWebView.GetWidth();
        int height = GpmWebView.GetHeight();
        ...
    }
}
```
